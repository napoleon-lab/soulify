<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spotify Search Results</title>
    <link rel="icon" type="image/png" href="/static/images/favicon-32x32.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #333333;
            color: #ffffff;
            text-align: center;
            padding-top: 50px;
        }

        .result-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .result-item {
            background-color: #444;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .result-item img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer; /* Added to indicate it's clickable for preview */
        }

        .result-title {
            font-size: 16px;
            margin-top: 10px;
        }

        .result-subtitle {
            font-size: 14px;
            color: #aaaaaa;
        }

        button {
            background-color: #1DB954;
            border: none;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        button:hover {
            background-color: #1aa34a;
        }
        
        a {
            color: #E0E0E0;
            text-decoration: none;
        }

        a:hover {
            color: #FFFFFF;
            text-decoration: underline;
        }
    </style>

<script>
    function downloadResult(type, artistName, albumName = '', trackName = '', playlistId = '', totalTracks = 0) { // Include albumName and trackName
        console.log("Requesting download for:", type, artistName, albumName, trackName, playlistId, totalTracks); // Debugging log

        let url = '';
        let data = {};

        // Define which route to call based on the type of download
        if (type === 'artist') {
            url = '/download_artist';
            data = { artistName: artistName };
        } else if (type === 'album') {
            url = '/download_album';
            data = { artistName: artistName, albumName: albumName, totalTracks: parseInt(totalTracks, 10) }; // Pass totalTracks
        } else if (type === 'track') {
            url = '/download_track';
            data = { artistName: artistName, albumName: albumName, trackName: trackName }; // Pass artistName, albumName, and trackName
        } else if (type === 'playlist') {
            url = '/download_playlist';
            data = { playlistId: playlistId };
        } else {
            alert('Invalid download type');
            return;
        }

        // Send the POST request to initiate the download and handle the response
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Failed to initiate download: ${response.statusText}`);
            }
            return response.json();
        })
        .then(json => {
            if (json.status === 'success') {
                // Notify the user that the download has been queued successfully
                alert(`Download has been added to the queue. Command ID: ${json.command_id}`);
            } else {
                alert(`Failed to initiate download: ${json.message}`);
            }
        })
        .catch(error => {
            console.error('Error sending download request:', error);
            alert('Error sending download request: ' + error.message);
        });
    }

    // Function to play track preview when album art is clicked (for tracks only)
    function playPreview(trackId) {
        fetch(`/track_preview/${trackId}`)
        .then(response => response.json())
        .then(data => {
            const previewUrl = data.preview_url;
            if (previewUrl) {
                let audio = document.getElementById('preview-audio');
                if (!audio) {
                    audio = document.createElement('audio');
                    audio.id = 'preview-audio';
                    document.body.appendChild(audio);
                }
                audio.src = previewUrl;
                audio.play();
            } else {
                alert('Preview not available for this track.');
            }
        })
        .catch(error => {
            console.error('Error fetching track preview:', error);
            alert('Error fetching track preview.');
        });
    }
</script>



</head>
<body>
    {% include 'nav.html' %}
    <h1>Search Results</h1>

    {% if search_type == "artist" %}
        <h2>Artists:</h2>
        <div class="result-list">
            {% for artist in search_results['artists']['items'] %}
            <div class="result-item">
                <img src="{{ artist['images'][0]['url'] if artist['images'] else 'https://cdn.icon-icons.com/icons2/1504/PNG/512/unknown_103657.png' }}" alt="{{ artist['name'] }}">
                <div class="result-title">
                    <a href="/artist/{{ artist['id'] }}">{{ artist['name'] }}</a>
                </div>
                <button onclick="downloadResult('artist', '{{ artist['name'] }}')">Queue Artist Download</button>
            </div>
            {% endfor %}
        </div>

    {% elif search_type == "album" %}
    <h2>Albums:</h2>
    <div class="result-list">
        {% for album in search_results['albums']['items'] %}
        <div class="result-item">
            <img src="{{ album['images'][0]['url'] if album['images'] else 'https://cdn.icon-icons.com/icons2/1504/PNG/512/unknown_103657.png' }}" alt="{{ album['name'] }}">
            <div class="result-title">
                <a href="/albumtracks/{{ album['id'] }}">{{ album['name'] }}</a> ({{ album['total_tracks'] }} tracks) <!-- Display total track count -->
            </div>
            <div class="result-subtitle">
                by <a href="/artist/{{ album['artists'][0]['id'] }}">{{ album['artists'][0]['name'] }}</a>
            </div>
            <button 
                onclick="downloadResult('album', '{{ album['artists'][0]['name'] }}', '{{ album['name'] }}', '', {{ album['total_tracks'] }})">
                Queue Album Download
            </button> <!-- Pass total tracks to downloadResult -->
        </div>
        {% endfor %}
    </div>

    {% elif search_type == "track" %}
        <h2>Tracks:</h2>
        <div class="result-list">
            {% for track in search_results['tracks']['items'] %}
            <div class="result-item">
                <img src="{{ track['album']['images'][0]['url'] if track['album']['images'] else 'https://cdn.icon-icons.com/icons2/1504/PNG/512/unknown_103657.png' }}" alt="{{ track['name'] }}" onclick="playPreview('{{ track['id'] }}')">
                <div class="result-title">
                    <a href="/albumtracks/{{ track['album']['id'] }}">{{ track['name'] }}</a>
                </div>
                <div class="result-subtitle">
                    by <a href="/artist/{{ track['artists'][0]['id'] }}">{{ track['artists'][0]['name'] }}</a>
                </div>
                <button onclick="downloadResult('track', '{{ track['artists'][0]['name'] }}', '{{ track['album']['name'] }}', '{{ track['name'] }}')">Queue Track Download</button>
            </div>
            {% endfor %}
        </div>

    {% elif search_type == "playlist" %}
        <h2>Playlists:</h2>
        <div class="result-list">
            {% for playlist in search_results['playlists']['items'] %}
            <div class="result-item">
                <img src="{{ playlist['images'][0]['url'] if playlist['images'] else 'https://cdn.icon-icons.com/icons2/1504/PNG/512/unknown_103657.png' }}" alt="{{ playlist['name'] }}">
                <div class="result-title">{{ playlist['name'] }}</div>
                <div class="result-subtitle">
                    by {{ playlist['owner']['display_name'] }}
                </div>
                <button onclick="downloadResult('playlist', '', '', '{{ playlist['id'] }}')">Queue Playlist Download</button>
            </div>
            {% endfor %}
        </div>

    {% else %}
        <p>No search results found.</p>
    {% endif %}

    <!-- Hidden audio element for track preview -->
    <audio id="preview-audio" style="display:none;"></audio>
</body>
</html>

